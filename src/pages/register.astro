---
import Layout from "../layouts/Layout.astro";
import AuthForm from "../components/AuthForm.astro";
import { registerUser } from "../controllers/userController";
import { MONTH_IN_MILLISECONDS } from "../constants/constants";
import "./../styles/auth.css";

if (Astro.cookies.has("token")) {
  return Astro.redirect("/dashboard");
}

if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();
    const email = data.get("email") as string;
    const username = data.get("username") as string;
    const password = data.get("password") as string;
    let response = await registerUser(email, username, password);

    if (response.message === "success") {
      Astro.cookies.set("token", response.data.token, {
        maxAge: MONTH_IN_MILLISECONDS,
      });
      return Astro.redirect("/dashboard");
    }
  } catch (error) {
    if (error instanceof Error) {
      console.error(error.message, "ERROR");
    }
  }
}
---

<Layout title="Money Moon | Register">
  <AuthForm login={false} />
</Layout>
