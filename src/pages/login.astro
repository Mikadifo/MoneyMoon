---
import Layout from "../layouts/Layout.astro";
import AuthForm from "../components/AuthForm.astro";
import { loginUser } from "./../controllers/userController";
import { $token } from "../stores/auth";
import "./../styles/auth.css";

if ($token.get()) {
  return Astro.redirect("/");
}

if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();
    const email = data.get("email") as string;
    const password = data.get("password") as string;
    let response = await loginUser(email, password);
    if (response.message === "success") {
      $token.set(response.data.token);
      return Astro.redirect("/");
    }
  } catch (error) {
    if (error instanceof Error) {
      console.error(error.message, "ERROR");
    }
  }
}
---

<Layout title="Money Moon | Login">
  <AuthForm login={true} />
</Layout>
